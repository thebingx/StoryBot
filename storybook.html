<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Story Book - Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root { --mario-red: #e52521; --mario-blue: #049cd8; --mario-yellow: #fbd000; --grass-green: #43ad11; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: var(--mario-blue); display: flex; justify-content: center; padding: 20px; }
        #container { width: 90%; max-width: 700px; background: white; border: 6px solid #000; border-radius: 20px; padding: 30px; box-shadow: 10px 10px 0px rgba(0,0,0,0.2); }
        h1 { font-family: 'Press Start 2P', cursive; font-size: 1.2rem; color: var(--mario-red); text-align: center; }
        .story-item { border-bottom: 4px solid #eee; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .story-info { text-align: left; }
        .story-date { font-size: 0.7rem; color: #888; margin-bottom: 5px; }
        .story-title { font-weight: bold; color: var(--mario-blue); }
        .mario-btn { background: var(--grass-green); color: white; padding: 10px 15px; font-family: 'Press Start 2P', cursive; font-size: 0.5rem; border: 3px solid #2d7a0b; border-radius: 8px; cursor: pointer; text-decoration: none; }
    </style>
</head>
<body>
    <div id="container">
        <h1>STORY BOOK</h1>
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/" class="mario-btn" style="background: var(--mario-red); border-color: #b11a17;">BACK TO START</a>
        </div>
        <div id="story-list"></div>
    </div>

    <script>
        async function loadStories() {
            const res = await fetch('/api/stories');
            const stories = await res.json();
            const list = document.getElementById('story-list');
            list.innerHTML = ''; // Clear the list before adding new items
            
            // Show newest stories first
            stories.reverse().forEach((story, index) => {
                const title = story.text.split('\n')[0].replace('TITLE:', '').trim() || "Untitled Adventure";
                const div = document.createElement('div');
                div.className = 'story-item';
                div.innerHTML = `
                    <div class="story-info">
                        <div class="story-date">${story.created || 'Unknown Date'}</div>
                        <div class="story-title">${title}</div>
                    </div>
                    <div>
                        <button class="mario-btn" onclick='replayStory(${JSON.stringify(story).replace(/'/g, "&apos;")})'>REPLAY</button>
                        <button class="mario-btn" style="background: var(--mario-red); border-color: #b11a17; margin-left: 10px;" onclick='deleteStory(${index})'>DELETE</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function replayStory(story) {
            // Save story to session storage so index.html can read it
            sessionStorage.setItem('replay_story', JSON.stringify(story));
            window.location.href = '/';
        }

        async function deleteStory(index) {
            if (confirm('Are you sure you want to delete this story?')) {
                await fetch('/api/stories/' + index, { method: 'DELETE' });
                loadStories(); // Reload the list
            }
        }

        loadStories();
    </script>
</body>
</html>